<!-- Quick Capture Feature -->
<style>
    /* Main floating action button */
    #main-fab {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background-color: #2c3e50;
        color: white;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        z-index: 1001;
        border: none;
    }

    #main-fab:hover {
        background-color: #34495e;
        transform: scale(1.1);
    }

    #main-fab.open {
        background-color: #e74c3c;
    }

    /* Action menu */
    #fab-menu {
        position: fixed;
        bottom: 5rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    #fab-menu.open {
        opacity: 1;
        pointer-events: all;
    }

    .fab-menu-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: white;
        border-radius: 2rem;
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .fab-menu-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transform: translateX(-4px);
    }

    .fab-menu-item-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .fab-menu-item-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #333;
    }

    #fab-bookmarks-badge {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #f39c12;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        font-weight: 600;
        display: none;
        align-items: center;
        justify-content: center;
        transform: translate(25%, -25%);
    }

    #quick-capture-modal {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .capture-mode-btn {
        transition: all 0.2s ease;
    }

    .capture-mode-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .capture-textarea {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        resize: vertical;
        min-height: 150px;
    }

    .note-item {
        border: 1px solid rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }

    .note-item:hover {
        border-color: rgba(0, 0, 0, 0.1);
        background-color: #fafafa;
    }
</style>

<!-- Main Floating Action Button -->
<button id="main-fab" title="Actions">
    <svg id="main-fab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="1"/>
        <circle cx="12" cy="5" r="1"/>
        <circle cx="12" cy="19" r="1"/>
    </svg>
    <div id="fab-bookmarks-badge">0</div>
</button>

<!-- Floating Action Menu -->
<div id="fab-menu">
    <div class="fab-menu-item" id="fab-capture" title="Quick Capture">
        <div class="fab-menu-item-icon" style="background-color: #3498db;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
            </svg>
        </div>
        <div class="fab-menu-item-label">Quick Capture</div>
    </div>

    <div class="fab-menu-item" id="fab-bookmarks" title="Bookmarks" style="display: none;">
        <div class="fab-menu-item-icon" style="background-color: #f39c12;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
        </div>
        <div class="fab-menu-item-label">Bookmarks</div>
    </div>

    <div class="fab-menu-item" id="fab-scroll-top" title="Scroll to Top">
        <div class="fab-menu-item-icon" style="background-color: #2c3e50;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 19V5M5 12l7-7 7 7"/>
            </svg>
        </div>
        <div class="fab-menu-item-label">Scroll to Top</div>
    </div>
</div>

<!-- Quick Capture Modal -->
<div id="quick-capture-modal" class="fixed top-0 left-0 w-100 h-100 flex items-center justify-center" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.7);">
    <div class="bg-white br3 shadow-5 relative" style="width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
        <!-- Modal Header -->
        <div class="flex items-center justify-between pa3 bb b--black-10">
            <h3 id="capture-modal-title" class="f5 fw5 near-black ma0">Quick Capture</h3>
            <button id="close-capture-modal" class="bn bg-transparent pointer f3 gray lh-solid" style="line-height: 1;">&times;</button>
        </div>

        <!-- Mode Selection -->
        <div id="mode-selection" class="pa3" style="display: flex; gap: 0.5rem; flex-direction: column;">
            <p class="f6 gray ma0 mb2">What would you like to capture?</p>
            <button class="capture-mode-btn button-reset bn pa3 br2 bg-light-gray near-black f6 fw5 pointer" data-mode="note">
                <div class="flex items-center" style="gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="tl">
                        <div class="fw6">Quick Note</div>
                        <div class="f7 gray">Capture a quick thought or idea</div>
                    </div>
                </div>
            </button>
            <button class="capture-mode-btn button-reset bn pa3 br2 bg-light-gray near-black f6 fw5 pointer" data-mode="journal">
                <div class="flex items-center" style="gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <div class="tl">
                        <div class="fw6">Today's Journal</div>
                        <div class="f7 gray">Add to today's journal entry</div>
                    </div>
                </div>
            </button>
            <button class="capture-mode-btn button-reset bn pa3 br2 bg-light-gray near-black f6 fw5 pointer" data-mode="annotation">
                <div class="flex items-center" style="gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="18" x2="12" y2="12"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    <div class="tl">
                        <div class="fw6">Page Annotation</div>
                        <div class="f7 gray" id="current-page-title">Note for this page</div>
                    </div>
                </div>
            </button>
            <button class="capture-mode-btn button-reset bn pa3 br2 bg-light-gray near-black f6 fw5 pointer" data-mode="view">
                <div class="flex items-center" style="gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <div class="tl">
                        <div class="fw6">View All Captures</div>
                        <div class="f7 gray">Browse all your notes and journal entries</div>
                    </div>
                </div>
            </button>
        </div>

        <!-- Capture Form -->
        <div id="capture-form" style="display: none;" class="flex flex-column" style="flex: 1; overflow: hidden;">
            <div class="pa3 bb b--black-10">
                <button id="back-to-modes" class="button-reset bn pa0 pointer f6 gray hover-near-black" style="display: flex; align-items: center; gap: 0.25rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
            </div>
            <div class="pa3 overflow-y-auto" style="flex: 1;">
                <textarea id="capture-textarea" class="capture-textarea w-100 pa2 br2 ba b--black-20 f6" placeholder="Write your thoughts..."></textarea>
            </div>
            <div class="flex items-center justify-end pa3 bt b--black-10" style="gap: 0.5rem;">
                <button id="save-capture" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim">
                    Save
                </button>
            </div>
        </div>

        <!-- View All Captures -->
        <div id="view-captures" style="display: none; flex: 1; overflow: hidden;" class="flex flex-column">
            <div class="pa3 bb b--black-10 flex items-center justify-between">
                <button id="back-to-modes-view" class="button-reset bn pa0 pointer f6 gray hover-near-black" style="display: flex; align-items: center; gap: 0.25rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="filter-notes" class="button-reset bn ph2 pv1 br2 bg-light-gray near-black f7 fw5 pointer" data-active="true">Notes</button>
                    <button id="filter-journal" class="button-reset bn ph2 pv1 br2 bg-light-gray near-black f7 fw5 pointer" data-active="true">Journal</button>
                    <button id="filter-annotations" class="button-reset bn ph2 pv1 br2 bg-light-gray near-black f7 fw5 pointer" data-active="true">Annotations</button>
                </div>
            </div>
            <div id="captures-list" class="pa3 overflow-y-auto" style="flex: 1;">
                <p class="gray tc pv4">No captures yet</p>
            </div>
            <div class="flex items-center justify-end pa3 bt b--black-10" style="gap: 0.5rem;">
                <button id="export-captures" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim">
                    Export All
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const STORAGE_KEY = 'quick-captures';
    const BOOKMARKS_STORAGE_KEY = 'topics-bookmarks';

    // DOM elements
    const mainFab = document.getElementById('main-fab');
    const fabMenu = document.getElementById('fab-menu');
    const fabCapture = document.getElementById('fab-capture');
    const fabBookmarks = document.getElementById('fab-bookmarks');
    const fabScrollTop = document.getElementById('fab-scroll-top');
    const fabBookmarksBadge = document.getElementById('fab-bookmarks-badge');
    const mainFabIcon = document.getElementById('main-fab-icon');

    const captureModal = document.getElementById('quick-capture-modal');
    const closeModalBtn = document.getElementById('close-capture-modal');
    const modeSelection = document.getElementById('mode-selection');
    const captureForm = document.getElementById('capture-form');
    const viewCaptures = document.getElementById('view-captures');
    const captureTextarea = document.getElementById('capture-textarea');
    const saveCaptureBtn = document.getElementById('save-capture');
    const backToModesBtn = document.getElementById('back-to-modes');
    const backToModesViewBtn = document.getElementById('back-to-modes-view');
    const modalTitle = document.getElementById('capture-modal-title');
    const currentPageTitle = document.getElementById('current-page-title');
    const capturesList = document.getElementById('captures-list');
    const exportBtn = document.getElementById('export-captures');

    let currentMode = null;
    let currentPageUrl = window.location.pathname;
    let currentPageName = document.title;
    let menuOpen = false;

    // FAB menu functions
    function toggleFabMenu() {
        menuOpen = !menuOpen;
        fabMenu.classList.toggle('open', menuOpen);
        mainFab.classList.toggle('open', menuOpen);

        // Change icon when open
        if (menuOpen) {
            mainFabIcon.innerHTML = '<path d="M18 6L6 18M6 6l12 12"/>';
        } else {
            mainFabIcon.innerHTML = '<circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>';
        }
    }

    function closeFabMenu() {
        menuOpen = false;
        fabMenu.classList.remove('open');
        mainFab.classList.remove('open');
        mainFabIcon.innerHTML = '<circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>';
    }

    // Update bookmarks button visibility and badge
    function updateBookmarksButton() {
        try {
            const bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_STORAGE_KEY) || '[]');
            if (bookmarks.length > 0) {
                fabBookmarks.style.display = 'flex';
                fabBookmarksBadge.style.display = 'flex';
                fabBookmarksBadge.textContent = bookmarks.length;
            } else {
                fabBookmarks.style.display = 'none';
                fabBookmarksBadge.style.display = 'none';
            }
        } catch (e) {
            fabBookmarks.style.display = 'none';
            fabBookmarksBadge.style.display = 'none';
        }
    }

    // Scroll to top with smooth behavior
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        closeFabMenu();
    }

    // Make updateGlobalBookmarks available globally for topics list
    window.updateGlobalBookmarks = updateBookmarksButton;

    // Update current page info
    currentPageTitle.textContent = `Note for: ${currentPageName}`;

    // Storage functions
    function getCaptures() {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : { notes: [], journal: [], annotations: [] };
    }

    function saveCaptures(captures) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(captures));
    }

    function addCapture(mode, content, pageUrl = null, pageTitle = null) {
        const captures = getCaptures();
        const capture = {
            id: Date.now().toString(),
            content: content,
            timestamp: new Date().toISOString(),
            pageUrl: pageUrl,
            pageTitle: pageTitle
        };

        if (mode === 'note') {
            captures.notes.push(capture);
        } else if (mode === 'journal') {
            captures.journal.push(capture);
        } else if (mode === 'annotation') {
            captures.annotations.push(capture);
        }

        saveCaptures(captures);
        return capture;
    }

    function deleteCapture(mode, id) {
        const captures = getCaptures();
        if (mode === 'note') {
            captures.notes = captures.notes.filter(c => c.id !== id);
        } else if (mode === 'journal') {
            captures.journal = captures.journal.filter(c => c.id !== id);
        } else if (mode === 'annotation') {
            captures.annotations = captures.annotations.filter(c => c.id !== id);
        }
        saveCaptures(captures);
    }

    // Modal functions
    function openModal() {
        captureModal.style.display = 'flex';
        showModeSelection();
    }

    function closeModal() {
        captureModal.style.display = 'none';
        captureTextarea.value = '';
        currentMode = null;
    }

    function showModeSelection() {
        modeSelection.style.display = 'flex';
        captureForm.style.display = 'none';
        viewCaptures.style.display = 'none';
        modalTitle.textContent = 'Quick Capture';
    }

    function showCaptureForm(mode) {
        currentMode = mode;
        modeSelection.style.display = 'none';
        captureForm.style.display = 'flex';

        if (mode === 'note') {
            modalTitle.textContent = 'Quick Note';
            captureTextarea.placeholder = 'Write your quick note...';
        } else if (mode === 'journal') {
            modalTitle.textContent = "Today's Journal";
            captureTextarea.placeholder = 'What happened today?';
        } else if (mode === 'annotation') {
            modalTitle.textContent = 'Page Annotation';
            captureTextarea.placeholder = `Write a note about "${currentPageName}"...`;
        }

        captureTextarea.focus();
    }

    function showViewCaptures() {
        modeSelection.style.display = 'none';
        captureForm.style.display = 'none';
        viewCaptures.style.display = 'flex';
        modalTitle.textContent = 'All Captures';
        renderCaptures();
    }

    function renderCaptures() {
        const captures = getCaptures();
        const filterNotes = document.getElementById('filter-notes').dataset.active === 'true';
        const filterJournal = document.getElementById('filter-journal').dataset.active === 'true';
        const filterAnnotations = document.getElementById('filter-annotations').dataset.active === 'true';

        let allCaptures = [];

        if (filterNotes) {
            allCaptures = allCaptures.concat(captures.notes.map(c => ({...c, type: 'note', icon: 'âš¡'})));
        }
        if (filterJournal) {
            allCaptures = allCaptures.concat(captures.journal.map(c => ({...c, type: 'journal', icon: 'ðŸ“…'})));
        }
        if (filterAnnotations) {
            allCaptures = allCaptures.concat(captures.annotations.map(c => ({...c, type: 'annotation', icon: 'ðŸ“'})));
        }

        // Sort by timestamp descending
        allCaptures.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allCaptures.length === 0) {
            capturesList.innerHTML = '<p class="gray tc pv4">No captures match the filters</p>';
            return;
        }

        capturesList.innerHTML = allCaptures.map(capture => `
            <div class="note-item bg-white br2 pa3 mb2">
                <div class="flex items-start justify-between mb2">
                    <div class="flex items-center" style="gap: 0.5rem;">
                        <span class="f5">${capture.icon}</span>
                        <div>
                            <div class="f6 fw6 near-black">${capture.type.charAt(0).toUpperCase() + capture.type.slice(1)}</div>
                            <div class="f7 gray">${new Date(capture.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                    <button class="delete-capture-btn bn bg-transparent pointer gray hover-red pa1" data-type="${capture.type}" data-id="${capture.id}">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 4L4 12M4 4l8 8"/>
                        </svg>
                    </button>
                </div>
                ${capture.pageTitle ? `<div class="f7 gray mb2">ðŸ“„ ${capture.pageTitle}</div>` : ''}
                <div class="f6 lh-copy" style="white-space: pre-wrap;">${capture.content}</div>
            </div>
        `).join('');

        // Add delete event listeners
        document.querySelectorAll('.delete-capture-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                const id = this.dataset.id;
                if (confirm('Delete this capture?')) {
                    deleteCapture(type, id);
                    renderCaptures();
                }
            });
        });
    }

    // Event listeners - FAB menu
    mainFab.addEventListener('click', toggleFabMenu);
    fabCapture.addEventListener('click', function() {
        closeFabMenu();
        openModal();
    });
    fabBookmarks.addEventListener('click', function() {
        closeFabMenu();
        // Trigger bookmarks modal if on topics page, or show view captures with bookmarks
        if (typeof window.showBookmarksModal === 'function') {
            window.showBookmarksModal();
        } else {
            showViewCaptures();
        }
    });
    fabScrollTop.addEventListener('click', scrollToTop);

    // Event listeners - Modal
    closeModalBtn.addEventListener('click', closeModal);
    backToModesBtn.addEventListener('click', showModeSelection);
    backToModesViewBtn.addEventListener('click', showModeSelection);

    // Initialize bookmarks button
    updateBookmarksButton();

    // Close on background click
    captureModal.addEventListener('click', function(e) {
        if (e.target === captureModal) {
            closeModal();
        }
    });

    // Close on ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && captureModal.style.display === 'flex') {
            closeModal();
        }
    });

    // Mode selection
    document.querySelectorAll('.capture-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            if (mode === 'view') {
                showViewCaptures();
            } else {
                showCaptureForm(mode);
            }
        });
    });

    // Save capture
    saveCaptureBtn.addEventListener('click', function() {
        const content = captureTextarea.value.trim();
        if (!content) {
            alert('Please write something first!');
            return;
        }

        if (currentMode === 'annotation') {
            addCapture(currentMode, content, currentPageUrl, currentPageName);
        } else {
            addCapture(currentMode, content);
        }

        closeModal();
    });

    // Filter toggles
    ['filter-notes', 'filter-journal', 'filter-annotations'].forEach(id => {
        document.getElementById(id).addEventListener('click', function() {
            const isActive = this.dataset.active === 'true';
            this.dataset.active = (!isActive).toString();
            this.style.backgroundColor = isActive ? '#f4f4f4' : '#2c3e50';
            this.style.color = isActive ? '#111' : '#fff';
            renderCaptures();
        });
    });

    // Export
    exportBtn.addEventListener('click', function() {
        const captures = getCaptures();
        let exportText = '# My Captures\n\n';

        if (captures.notes.length > 0) {
            exportText += '## Quick Notes\n\n';
            captures.notes.forEach(note => {
                exportText += `### ${new Date(note.timestamp).toLocaleString()}\n${note.content}\n\n---\n\n`;
            });
        }

        if (captures.journal.length > 0) {
            exportText += '## Journal Entries\n\n';
            captures.journal.forEach(entry => {
                exportText += `### ${new Date(entry.timestamp).toLocaleString()}\n${entry.content}\n\n---\n\n`;
            });
        }

        if (captures.annotations.length > 0) {
            exportText += '## Page Annotations\n\n';
            captures.annotations.forEach(ann => {
                exportText += `### ${ann.pageTitle}\n*${new Date(ann.timestamp).toLocaleString()}*\n\n${ann.content}\n\n---\n\n`;
            });
        }

        const blob = new Blob([exportText], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `captures-${new Date().toISOString().split('T')[0]}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
});
</script>
