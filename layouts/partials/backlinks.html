{{ $re := printf `["/(]%s.+["/)]` .page.File.LogicalName | lower }}
{{ $content_re := printf `.*\[%s\].*` .page.Title }}
{{ $backlinks := slice }}

{{ range where site.RegularPages "RelPermalink" "ne" .page.RelPermalink }}
	{{ if (findRE $re .RawContent 1) }}
		{{ $backlinks = $backlinks | append . }}
	{{ end }}
{{ end }}

{{ if gt (len $backlinks) 0 }}
<div class="backlinks-section mt5 pt4 bt b--black-10">
	<h3 class="f4 fw5 near-black mb3">
		<span class="mr2">ðŸ”—</span>
		Links to this note
		<span class="f6 fw4 gray ml2">({{ len $backlinks }})</span>
	</h3>

	<div class="backlinks-grid">
		{{ range $backlinks }}
			{{ $matches := findRE $content_re .RawContent}}
			<div class="backlink-card bg-white br2 pa3 mb3" data-backlink-url="{{ .RelPermalink }}" data-backlink-title="{{ .Title }}">
				<div class="backlink-card-wrapper relative">
					<a class="link near-black no-underline db" href="{{ .RelPermalink }}">
						<div class="f5 fw5 mb2 bb-hover">{{ .Title }}</div>
						{{ if $matches }}
							<div class="f6 gray lh-copy mt2">
								{{ range first 1 $matches }}
									{{ $.page.RenderString (dict "markup" "goldmark" "display" "inline") . }}
								{{ end }}
							</div>
						{{ end }}
					</a>
					<button class="backlink-preview-btn bn bg-transparent pointer absolute top-0 right-0 pa2"
							title="Preview content"
							style="opacity: 0.5; transition: opacity 0.2s;"
							onmouseover="this.style.opacity='1'"
							onmouseout="this.style.opacity='0.5'">
						<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M1 8s3-5 7-5 7 5 7 5-3 5-7 5-7-5-7-5z"/>
							<circle cx="8" cy="8" r="2"/>
						</svg>
					</button>
				</div>
			</div>
		{{ end }}
	</div>
</div>

<style>
	.backlinks-section {
		max-width: 100%;
	}

	.backlink-card-wrapper {
		position: relative;
	}

	.backlink-card {
		border: 1px solid rgba(0, 0, 0, 0.06);
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
	}

	.backlink-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		border-color: rgba(0, 0, 0, 0.1);
	}

	.backlink-preview-btn {
		color: #999;
	}

	.backlink-preview-btn:hover {
		color: #3498db;
	}

	.bb-hover {
		border-bottom: 1px solid transparent;
		transition: border-color 0.2s ease;
	}

	.backlink-card:hover .bb-hover {
		border-bottom-color: rgba(0, 0, 0, 0.2);
	}

	.backlink-card .gray {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	/* Remove default list styling from rendered content */
	.backlink-card ul {
		list-style: none;
		padding-left: 0;
	}

	.backlink-card blockquote {
		margin: 0;
		padding: 0;
		border: none;
	}

	/* Preview Modal */
	#backlink-preview-modal {
		backdrop-filter: blur(4px);
		-webkit-backdrop-filter: blur(4px);
	}

	/* Loading spinner */
	.backlink-spinner {
		border: 3px solid #f3f3f3;
		border-top: 3px solid #3498db;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	/* Preview content styling */
	#backlink-preview-content {
		line-height: 1.6;
	}

	#backlink-preview-content h1,
	#backlink-preview-content h2,
	#backlink-preview-content h3 {
		margin-top: 1.5rem;
		margin-bottom: 0.75rem;
	}

	#backlink-preview-content p {
		margin-bottom: 1rem;
	}

	#backlink-preview-content ul,
	#backlink-preview-content ol {
		margin-bottom: 1rem;
		padding-left: 2rem;
	}

	#backlink-preview-content code {
		background-color: #f5f5f5;
		padding: 0.125rem 0.25rem;
		border-radius: 0.25rem;
		font-size: 0.9em;
	}

	#backlink-preview-content pre {
		background-color: #f5f5f5;
		padding: 1rem;
		border-radius: 0.25rem;
		overflow-x: auto;
		margin-bottom: 1rem;
	}
</style>

<!-- Preview Modal for Backlinks -->
<div id="backlink-preview-modal" class="fixed top-0 left-0 w-100 h-100 flex items-center justify-center" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.7);">
	<div class="bg-white br3 shadow-5 relative" style="width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
		<!-- Modal Header -->
		<div class="flex items-center justify-between pa3 bb b--black-10">
			<h3 id="backlink-preview-title" class="f4 fw5 near-black ma0"></h3>
			<button id="close-backlink-modal" class="bn bg-transparent pointer f3 gray lh-solid" style="line-height: 1;">&times;</button>
		</div>

		<!-- Modal Content -->
		<div id="backlink-preview-content" class="pa4 overflow-y-auto flex-auto" style="max-height: calc(90vh - 150px);">
			<div class="flex items-center justify-center pv5">
				<div class="backlink-spinner"></div>
			</div>
		</div>

		<!-- Modal Footer -->
		<div class="flex items-center justify-end pa3 bt b--black-10">
			<a id="visit-backlink" href="#" target="_blank" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim no-underline">
				Visit Page â†’
			</a>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const backlinkPreviewModal = document.getElementById('backlink-preview-modal');
		const backlinkPreviewTitle = document.getElementById('backlink-preview-title');
		const backlinkPreviewContent = document.getElementById('backlink-preview-content');
		const closeBacklinkModalBtn = document.getElementById('close-backlink-modal');
		const visitBacklinkBtn = document.getElementById('visit-backlink');

		// Open backlink preview modal
		async function openBacklinkPreview(backlinkCard) {
			const title = backlinkCard.getAttribute('data-backlink-title');
			const url = backlinkCard.getAttribute('data-backlink-url');

			// Set title and link
			backlinkPreviewTitle.textContent = title;
			visitBacklinkBtn.href = url;

			// Show modal with loading state
			backlinkPreviewModal.style.display = 'flex';
			backlinkPreviewContent.innerHTML = '<div class="flex items-center justify-center pv5"><div class="backlink-spinner"></div></div>';

			// Fetch content
			try {
				const response = await fetch(url);
				const html = await response.text();

				// Parse HTML and extract main content
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');

				// Try to find the main content area
				const mainContent = doc.querySelector('main') || doc.querySelector('.post-content') || doc.querySelector('article');

				if (mainContent) {
					backlinkPreviewContent.innerHTML = mainContent.innerHTML;
				} else {
					backlinkPreviewContent.innerHTML = '<p class="gray">Could not load preview content.</p>';
				}
			} catch (error) {
				backlinkPreviewContent.innerHTML = '<p class="red">Error loading content. Please try visiting the page directly.</p>';
			}
		}

		// Close backlink preview modal
		function closeBacklinkPreview() {
			backlinkPreviewModal.style.display = 'none';
		}

		// Event listeners for backlink preview buttons
		document.querySelectorAll('.backlink-preview-btn').forEach(button => {
			button.addEventListener('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				const backlinkCard = this.closest('.backlink-card');
				openBacklinkPreview(backlinkCard);
			});
		});

		// Close modal
		closeBacklinkModalBtn.addEventListener('click', closeBacklinkPreview);

		// Close on background click
		backlinkPreviewModal.addEventListener('click', function(e) {
			if (e.target === backlinkPreviewModal) {
				closeBacklinkPreview();
			}
		});

		// Close on ESC key
		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape' && backlinkPreviewModal.style.display === 'flex') {
				closeBacklinkPreview();
			}
		});
	});
</script>

{{ else }}
<div class="backlinks-section mt5 pt4 bt b--black-10">
	<h3 class="f5 fw4 gray tc pv3">No notes link to this note yet</h3>
</div>
{{ end }}
