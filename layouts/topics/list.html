{{ define "main" }}
<main class="center ph3 ph4-l mw8">
    <!-- Header with refined spacing -->
    <div class="mt5 mb4">
        <h1 class="f1 fw3 heading-font near-black lh-title mb2">{{ .Title }}</h1>
        {{ if .Content }}
        <div class="post-content f5 lh-copy mid-gray">
            {{ .Content }}
        </div>
        {{ end }}
    </div>

    <!-- Sticky Search Container -->
    <div class="sticky-search-container bg-white br3 pa2 pa3-ns mb3 mb4-ns shadow-3" style="position: sticky; top: 1rem; z-index: 100;">
        <!-- Search Input -->
        <div class="mb2">
            <div class="flex items-center">
                <div class="flex-auto">
                    <input
                        type="text"
                        id="topic-search"
                        class="input-reset bn pa2 w-100 br2 bg-near-white f6 lh-copy"
                        placeholder="Search..."
                        autocomplete="off">
                </div>
                <button
                    id="clear-filters"
                    class="button-reset bn ph3 pv2 ml2 br2 bg-near-black white f6 fw5 pointer dim flex-shrink-0"
                    style="transition: all 0.2s ease;">
                    Clear
                </button>
            </div>
            <div class="mt1 f6 gray" id="search-count"></div>
        </div>

        <!-- Minimal Alphabet Navigation -->
        <div class="bt b--black-10 pt2 pt3-ns">
            <div class="alphabet-container-minimal flex flex-wrap justify-center items-center">
                {{ $letters := split "ABCDEFGHIJKLMNOPQRSTUVWXYZ" "" }}
                {{ range $letters }}
                <a href="#{{ . | lower }}" class="alphabet-link-minimal" data-letter="{{ . | lower }}">{{ . }}</a>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Topics List -->
    <div id="topics-list">
        <!-- Empty state (hidden by default) -->
        <div id="empty-state" class="dn tc pv5 ph4">
            <div class="f3 gray mb3">
                <svg class="w3 h3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <p class="f4 gray fw5">No topics found</p>
            <p class="f6 gray">Try adjusting your search</p>
        </div>

        <!-- Topic sections -->
        {{ $letters := split "ABCDEFGHIJKLMNOPQRSTUVWXYZ" "" }}
        {{ $.Scratch.Set "curLetter" "" }}
        {{ range $letter := $letters }}
            {{ $hasLetter := false }}
            {{ range $.Data.Pages.ByTitle }}
                {{ $firstChar := substr .Title 0 1 | upper }}
                {{ if eq $firstChar $letter }}
                    {{ $hasLetter = true }}
                    {{ if ne $firstChar ($.Scratch.Get "curLetter") }}
                        {{ if ne ($.Scratch.Get "curLetter") "" }}
                            </div><!-- close grid -->
                            </div><!-- close topic-category -->
                        {{ end }}
                        {{ $.Scratch.Set "curLetter" $firstChar }}
                        <div class="topic-category mb5" id="{{ $firstChar | lower }}" data-letter="{{ $firstChar | lower }}">
                            <div class="flex items-center mb3">
                                <h2 class="f2 fw2 heading-font near-black ma0 lh-solid">{{ $firstChar }}</h2>
                                <div class="ml3 f6 fw5 gray topic-count" data-letter="{{ $firstChar | lower }}"></div>
                            </div>
                            <div class="topic-grid">
                    {{ end }}
                    <div class="topic-item" data-letter="{{ $firstChar | lower }}" data-title="{{ .Title }}" data-filename="{{ .File.LogicalName }}" data-url="{{ .Params.externalLink | default .RelPermalink }}">
                        <div class="topic-card-wrapper relative">
                            <a class="db bg-white br2 pa3 no-underline topic-card" href="{{ .Params.externalLink | default .RelPermalink }}">
                                <h3 class="f5 fw5 near-black ma0 lh-title">{{ .Title }}</h3>
                            </a>
                            <div class="topic-actions absolute top-0 right-0 flex items-center pa2" style="gap: 0.125rem;">
                                <button class="bookmark-btn bn bg-transparent pointer"
                                        title="Bookmark"
                                        style="opacity: 0.5; transition: opacity 0.2s;"
                                        onmouseover="this.style.opacity='1'"
                                        onmouseout="this.style.opacity='0.5'">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 2h10a1 1 0 011 1v12l-6-3-6 3V3a1 1 0 011-1z"/>
                                    </svg>
                                </button>
                                <button class="preview-btn bn bg-transparent pointer"
                                        title="Preview content"
                                        style="opacity: 0.5; transition: opacity 0.2s;"
                                        onmouseover="this.style.opacity='1'"
                                        onmouseout="this.style.opacity='0.5'">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 8s3-5 7-5 7 5 7 5-3 5-7 5-7-5-7-5z"/>
                                        <circle cx="8" cy="8" r="2"/>
                                    </svg>
                                </button>
                                <button class="delete-marker bn bg-transparent pointer"
                                        title="Mark for deletion"
                                        style="opacity: 0.5; transition: opacity 0.2s;"
                                        onmouseover="this.style.opacity='1'"
                                        onmouseout="this.style.opacity='0.5'">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M2 4h12M5 4V3a1 1 0 011-1h4a1 1 0 011 1v1M13 4v9a1 1 0 01-1 1H4a1 1 0 01-1-1V4h10z"/>
                                        <path d="M6.5 7v4M9.5 7v4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                {{ end }}
            {{ end }}
        {{ end }}
        <!-- Close the last section if exists -->
        {{ if ne ($.Scratch.Get "curLetter") "" }}
            </div><!-- close grid -->
            </div><!-- close topic-category -->
        {{ end }}
    </div>
    
    <!-- Floating action buttons -->
    <div class="fixed bottom-2 right-2 flex flex-column items-end" style="gap: 0.5rem; z-index: 100;">
        <!-- Bookmarks button -->
        <div id="bookmarks-btn" class="bg-near-black white br-100 pa3 shadow-5 pointer" style="transition: all 0.3s ease; display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
        </div>
        <!-- Scroll to top button -->
        <div id="scroll-to-top" class="bg-main-color white br-100 pa3 shadow-5 pointer" style="transition: all 0.3s ease; opacity: 0; visibility: hidden;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19V5M5 12l7-7 7 7"/>
            </svg>
        </div>
    </div>

    <!-- Marked for deletion panel -->
    <div id="deletion-panel" class="fixed bottom-2 left-2 bg-white br3 pa3 shadow-5 z-5" style="max-width: 300px; display: none;">
        <div class="flex items-center justify-between mb2">
            <h4 class="f6 fw6 near-black ma0">Marked for Deletion</h4>
            <button id="close-panel" class="bn bg-transparent pointer f5 gray">×</button>
        </div>
        <div id="marked-count" class="f6 gray mb2">0 topics marked</div>
        <div id="marked-list" class="f7 overflow-y-auto" style="max-height: 200px;"></div>
        <div class="flex gap2 mt3">
            <button id="show-filenames" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim flex-auto">
                Show Files
            </button>
            <button id="clear-all" class="button-reset bn ph3 pv2 br2 bg-light-red near-black f6 fw5 pointer dim flex-auto">
                Clear All
            </button>
        </div>
    </div>

    <!-- Filenames Modal -->
    <div id="filenames-modal" class="fixed top-0 left-0 w-100 h-100 flex items-center justify-center" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.7);">
        <div class="bg-white br3 shadow-5 relative" style="width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pa3 bb b--black-10">
                <h3 class="f5 fw5 near-black ma0">Files to Delete</h3>
                <button id="close-filenames-modal" class="bn bg-transparent pointer f3 gray lh-solid" style="line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div class="pa3 overflow-y-auto flex-auto">
                <p class="f6 gray mb3">Copy this list to delete these files:</p>
                <pre id="filenames-content" class="f7 pa3 bg-near-white br2 overflow-x-auto" style="white-space: pre-wrap; word-break: break-all;"></pre>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end pa3 bt b--black-10" style="gap: 0.5rem;">
                <button id="copy-filenames" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim">
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div id="bookmarks-modal" class="fixed top-0 left-0 w-100 h-100 flex items-center justify-center" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.7);">
        <div class="bg-white br3 shadow-5 relative" style="width: 90%; max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pa3 bb b--black-10">
                <h3 class="f5 fw5 near-black ma0">
                    <span class="mr2">⭐</span>
                    Bookmarks
                    <span id="bookmarks-count" class="f6 fw4 gray ml2">(0)</span>
                </h3>
                <button id="close-bookmarks-modal" class="bn bg-transparent pointer f3 gray lh-solid" style="line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div id="bookmarks-list" class="pa3 overflow-y-auto flex-auto">
                <p class="gray tc pv4">No bookmarks yet</p>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end pa3 bt b--black-10" style="gap: 0.5rem;">
                <button id="clear-all-bookmarks" class="button-reset bn ph3 pv2 br2 bg-light-red near-black f6 fw5 pointer dim">
                    Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed top-0 left-0 w-100 h-100 flex items-center justify-center" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.7);">
        <div class="bg-white br3 shadow-5 relative" style="width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pa3 bb b--black-10">
                <h3 id="preview-title" class="f4 fw5 near-black ma0"></h3>
                <button id="close-modal" class="bn bg-transparent pointer f3 gray lh-solid" style="line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div id="preview-content" class="pa4 overflow-y-auto flex-auto" style="max-height: calc(90vh - 150px);">
                <div class="flex items-center justify-center pv5">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between pa3 bt b--black-10">
                <button id="mark-from-preview" class="button-reset bn ph3 pv2 br2 bg-light-red near-black f6 fw5 pointer dim">
                    Mark for Deletion
                </button>
                <a id="visit-topic" href="#" target="_blank" class="button-reset bn ph3 pv2 br2 bg-near-black white f6 fw5 pointer dim no-underline">
                    Visit Page →
                </a>
            </div>
        </div>
    </div>
</main>

<style>
    /* Modern/Minimal Custom Styles */

    /* Sticky search container with subtle backdrop blur */
    .sticky-search-container {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Refined alphabet navigation */
    .alphabet-container-minimal {
        gap: 0.25rem;
    }

    .alphabet-link-minimal {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #666;
        text-decoration: none;
        border-radius: 0.25rem;
        transition: all 0.15s ease;
        border-bottom: none !important;
    }

    .alphabet-link-minimal:hover {
        background-color: #f4f4f4;
        color: #111;
        border-bottom: none !important;
    }

    .alphabet-link-minimal.is-active {
        background-color: #111;
        color: white;
    }

    .alphabet-link-minimal.disabled {
        color: #ddd;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Modern topic grid */
    .topic-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
    }

    /* Minimal topic cards with subtle interactions */
    .topic-card {
        border: 1px solid rgba(0, 0, 0, 0.06);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .topic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: rgba(0, 0, 0, 0.1);
    }

    .topic-card:active {
        transform: translateY(0);
        transition-duration: 0.1s;
    }

    /* Search input focus state */
    #topic-search:focus {
        outline: 2px solid #111;
        outline-offset: 2px;
    }

    /* Clear button hover */
    #clear-filters:hover {
        background-color: #000;
    }

    #clear-filters:active {
        transform: scale(0.98);
    }

    /* Action button styles */
    .topic-card-wrapper {
        position: relative;
    }

    .bookmark-btn {
        color: #999;
    }

    .bookmark-btn:hover {
        color: #f39c12;
    }

    .topic-item.bookmarked .bookmark-btn {
        color: #f39c12;
        opacity: 1 !important;
    }

    .topic-item.bookmarked .bookmark-btn svg {
        fill: #f39c12;
    }

    .preview-btn {
        color: #999;
    }

    .preview-btn:hover {
        color: #3498db;
    }

    .delete-marker {
        color: #999;
    }

    .delete-marker:hover {
        color: #e74c3c;
    }

    .topic-item.marked-for-deletion .topic-card {
        border: 2px solid #e74c3c;
        opacity: 0.6;
        background-color: #fff5f5;
    }

    .topic-item.marked-for-deletion .delete-marker {
        color: #e74c3c;
        opacity: 1 !important;
    }

    /* Deletion panel */
    #deletion-panel {
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* Bookmarks modal */
    #bookmarks-btn:hover {
        background-color: #000;
        transform: scale(1.1);
    }

    .bookmark-item {
        border: 1px solid rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }

    .bookmark-item:hover {
        border-color: rgba(0, 0, 0, 0.1);
        background-color: #fafafa;
    }

    .remove-bookmark-btn {
        color: #999;
        transition: color 0.2s ease;
    }

    .remove-bookmark-btn:hover {
        color: #e74c3c;
    }

    /* Modals */
    #preview-modal,
    #filenames-modal,
    #bookmarks-modal {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    #filenames-content {
        font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    /* Loading spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Preview content styling */
    #preview-content {
        line-height: 1.6;
    }

    #preview-content h1,
    #preview-content h2,
    #preview-content h3 {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    #preview-content p {
        margin-bottom: 1rem;
    }

    #preview-content ul,
    #preview-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }

    #preview-content code {
        background-color: #f5f5f5;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.9em;
    }

    #preview-content pre {
        background-color: #f5f5f5;
        padding: 1rem;
        border-radius: 0.25rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    /* Scroll to top button */
    #scroll-to-top {
        background-color: #111;
        transition: all 0.3s ease;
    }

    #scroll-to-top:hover {
        background-color: #000;
        transform: scale(1.1);
    }

    #scroll-to-top.visible {
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .topic-grid {
            grid-template-columns: 1fr;
        }

        .alphabet-link-minimal {
            width: 1.75rem;
            height: 1.75rem;
            font-size: 0.8125rem;
        }
    }

    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // References to DOM elements
        const searchInput = document.getElementById('topic-search');
        const topicItems = document.querySelectorAll('.topic-item');
        const topicCategories = document.querySelectorAll('.topic-category');
        const alphabetLinks = document.querySelectorAll('.alphabet-link-minimal');
        const clearButton = document.getElementById('clear-filters');
        const searchCount = document.getElementById('search-count');
        const emptyState = document.getElementById('empty-state');
        const scrollTopBtn = document.getElementById('scroll-to-top');

        const totalTopics = topicItems.length;

        // Initialize topic counts for each letter
        function initializeTopicCounts() {
            topicCategories.forEach(category => {
                const letter = category.getAttribute('data-letter');
                const items = category.querySelectorAll('.topic-item');
                const countEl = category.querySelector('.topic-count');
                if (countEl) {
                    countEl.textContent = `(${items.length})`;
                }
            });
        }

        // Update search count and empty state
        function updateSearchCount(visibleCount) {
            if (searchInput.value.trim() === '') {
                searchCount.textContent = `${totalTopics} topics`;
            } else {
                searchCount.textContent = `${visibleCount} of ${totalTopics} topics`;
            }

            // Show/hide empty state
            if (visibleCount === 0) {
                emptyState.classList.remove('dn');
            } else {
                emptyState.classList.add('dn');
            }
        }

        // Filter topics based on search input
        function filterTopics() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let visibleCount = 0;

            // Reset visibility
            topicItems.forEach(item => item.style.display = 'none');
            topicCategories.forEach(category => category.style.display = 'none');

            // Filter and show matching topics
            topicItems.forEach(item => {
                const title = item.getAttribute('data-title').toLowerCase();
                const letter = item.getAttribute('data-letter');

                if (title.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;

                    // Show parent category
                    const parentCategory = document.querySelector(`.topic-category[data-letter="${letter}"]`);
                    if (parentCategory) {
                        parentCategory.style.display = 'block';
                    }
                }
            });

            // Update UI
            updateSearchCount(visibleCount);
            updateAlphabetLinks();
            updateCategoryCounts();
        }

        // Update category counts based on visible items
        function updateCategoryCounts() {
            topicCategories.forEach(category => {
                const visibleItems = Array.from(category.querySelectorAll('.topic-item'))
                    .filter(item => item.style.display !== 'none');
                const countEl = category.querySelector('.topic-count');
                if (countEl) {
                    countEl.textContent = `(${visibleItems.length})`;
                }
            });
        }

        // Update alphabet navigation state
        function updateAlphabetLinks() {
            const visibleCategories = Array.from(topicCategories)
                .filter(cat => cat.style.display !== 'none');
            const visibleLetters = visibleCategories.map(cat =>
                cat.getAttribute('data-letter').toLowerCase()
            );

            alphabetLinks.forEach(link => {
                const letter = link.getAttribute('data-letter').toLowerCase();
                if (visibleLetters.includes(letter)) {
                    link.classList.remove('disabled');
                } else {
                    link.classList.add('disabled');
                }
            });
        }

        // Scroll to specific letter section
        function scrollToLetter(letter) {
            const section = document.getElementById(letter.toLowerCase());
            if (section) {
                // Calculate offset based on search container height + some padding
                const searchContainer = document.querySelector('.sticky-search-container');
                const offset = searchContainer ? searchContainer.offsetHeight + 20 : 150;
                const elementPosition = section.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }

        // Highlight active letter based on scroll position
        function highlightActiveLetterOnScroll() {
            const categories = Array.from(topicCategories).filter(cat =>
                cat.style.display !== 'none'
            );

            let activeCategory = null;
            for (let category of categories) {
                const rect = category.getBoundingClientRect();
                if (rect.top <= 200 && rect.bottom >= 200) {
                    activeCategory = category;
                    break;
                }
            }

            alphabetLinks.forEach(link => link.classList.remove('is-active'));

            if (activeCategory) {
                const activeLetter = activeCategory.getAttribute('data-letter');
                const activeLink = document.querySelector(
                    `.alphabet-link-minimal[data-letter="${activeLetter}"]`
                );
                if (activeLink && !activeLink.classList.contains('disabled')) {
                    activeLink.classList.add('is-active');
                }
            }
        }

        // Clear all filters
        function clearFilters() {
            searchInput.value = '';
            topicItems.forEach(item => item.style.display = 'block');
            topicCategories.forEach(category => category.style.display = 'block');
            alphabetLinks.forEach(link => link.classList.remove('disabled'));
            updateSearchCount(totalTopics);
            initializeTopicCounts();
            emptyState.classList.add('dn');
        }

        // Event Listeners
        searchInput.addEventListener('input', filterTopics);
        clearButton.addEventListener('click', clearFilters);

        alphabetLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.classList.contains('disabled')) {
                    const letter = this.getAttribute('data-letter');
                    scrollToLetter(letter);
                }
            });
        });

        // Scroll to top button
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 500) {
                scrollTopBtn.classList.add('visible');
            } else {
                scrollTopBtn.classList.remove('visible');
            }
        }, { passive: true });

        scrollTopBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Highlight active letter on scroll
        window.addEventListener('scroll', highlightActiveLetterOnScroll, { passive: true });

        // Initialize
        initializeTopicCounts();
        updateSearchCount(totalTopics);
        highlightActiveLetterOnScroll();

        // ===== Mark for Deletion Feature =====
        const STORAGE_KEY = 'topics-marked-for-deletion';
        const deletionPanel = document.getElementById('deletion-panel');
        const markedCountEl = document.getElementById('marked-count');
        const markedListEl = document.getElementById('marked-list');
        const showFilenamesBtn = document.getElementById('show-filenames');
        const clearAllBtn = document.getElementById('clear-all');
        const closePanelBtn = document.getElementById('close-panel');
        const filenamesModal = document.getElementById('filenames-modal');
        const filenamesContent = document.getElementById('filenames-content');
        const closeFilenamesModalBtn = document.getElementById('close-filenames-modal');
        const copyFilenamesBtn = document.getElementById('copy-filenames');

        // Load marked topics from localStorage
        function getMarkedTopics() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // Save marked topics to localStorage
        function saveMarkedTopics(topics) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(topics));
        }

        // Update the deletion panel UI
        function updateDeletionPanel() {
            const marked = getMarkedTopics();
            markedCountEl.textContent = `${marked.length} topic${marked.length !== 1 ? 's' : ''} marked`;

            if (marked.length > 0) {
                deletionPanel.style.display = 'block';
                markedListEl.innerHTML = marked.map(item =>
                    `<div class="pv1 bb b--black-10">${item.title}</div>`
                ).join('');
            } else {
                deletionPanel.style.display = 'none';
            }
        }

        // Apply marked state to topic cards
        function applyMarkedStates() {
            const marked = getMarkedTopics();
            const markedFilenames = new Set(marked.map(m => m.filename));

            topicItems.forEach(item => {
                const filename = item.getAttribute('data-filename');
                if (markedFilenames.has(filename)) {
                    item.classList.add('marked-for-deletion');
                } else {
                    item.classList.remove('marked-for-deletion');
                }
            });
        }

        // Toggle marked state for a topic
        function toggleMarked(topicItem) {
            const filename = topicItem.getAttribute('data-filename');
            const title = topicItem.getAttribute('data-title');
            const marked = getMarkedTopics();
            const index = marked.findIndex(m => m.filename === filename);

            if (index > -1) {
                // Unmark
                marked.splice(index, 1);
            } else {
                // Mark
                marked.push({ filename, title });
            }

            saveMarkedTopics(marked);
            applyMarkedStates();
            updateDeletionPanel();
        }

        // Show filenames in modal
        function showFilenamesModal() {
            const marked = getMarkedTopics();
            if (marked.length === 0) return;

            const content = marked.map(m => m.filename).join('\n');
            filenamesContent.textContent = content;
            filenamesModal.style.display = 'flex';
        }

        // Close filenames modal
        function closeFilenamesModal() {
            filenamesModal.style.display = 'none';
        }

        // Copy filenames to clipboard
        async function copyFilenames() {
            const content = filenamesContent.textContent;
            try {
                await navigator.clipboard.writeText(content);
                // Visual feedback
                const originalText = copyFilenamesBtn.textContent;
                copyFilenamesBtn.textContent = 'Copied!';
                copyFilenamesBtn.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    copyFilenamesBtn.textContent = originalText;
                    copyFilenamesBtn.style.backgroundColor = '';
                }, 2000);
            } catch (err) {
                alert('Failed to copy to clipboard. Please copy manually.');
            }
        }

        // Clear all marked topics
        function clearAllMarked() {
            if (confirm('Clear all marked topics?')) {
                saveMarkedTopics([]);
                applyMarkedStates();
                updateDeletionPanel();
            }
        }

        // Event listeners for delete markers
        document.querySelectorAll('.delete-marker').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const topicItem = this.closest('.topic-item');
                toggleMarked(topicItem);
            });
        });

        // Event listeners for panel buttons
        showFilenamesBtn.addEventListener('click', showFilenamesModal);
        clearAllBtn.addEventListener('click', clearAllMarked);
        closePanelBtn.addEventListener('click', () => {
            deletionPanel.style.display = 'none';
        });

        // Event listeners for filenames modal
        closeFilenamesModalBtn.addEventListener('click', closeFilenamesModal);
        copyFilenamesBtn.addEventListener('click', copyFilenames);

        // Close filenames modal on background click
        filenamesModal.addEventListener('click', function(e) {
            if (e.target === filenamesModal) {
                closeFilenamesModal();
            }
        });

        // Close filenames modal on ESC key (only if preview modal is not open)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && filenamesModal.style.display === 'flex' && previewModal.style.display !== 'flex') {
                closeFilenamesModal();
            }
        });

        // Initialize marked topics on page load
        applyMarkedStates();
        updateDeletionPanel();

        // ===== Bookmarks Feature =====
        const BOOKMARKS_STORAGE_KEY = 'topics-bookmarks';

        // Load bookmarks from localStorage
        function getBookmarks() {
            const stored = localStorage.getItem(BOOKMARKS_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // Save bookmarks to localStorage
        function saveBookmarks(bookmarks) {
            localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));
        }

        // Apply bookmarked state to topic cards
        function applyBookmarkedStates() {
            const bookmarks = getBookmarks();
            const bookmarkedUrls = new Set(bookmarks.map(b => b.url));

            topicItems.forEach(item => {
                const url = item.getAttribute('data-url');
                if (bookmarkedUrls.has(url)) {
                    item.classList.add('bookmarked');
                } else {
                    item.classList.remove('bookmarked');
                }
            });
        }

        // Toggle bookmark for a topic
        function toggleBookmark(topicItem) {
            const url = topicItem.getAttribute('data-url');
            const title = topicItem.getAttribute('data-title');
            const filename = topicItem.getAttribute('data-filename');
            const bookmarks = getBookmarks();
            const index = bookmarks.findIndex(b => b.url === url);

            if (index > -1) {
                // Remove bookmark
                bookmarks.splice(index, 1);
            } else {
                // Add bookmark
                bookmarks.push({ url, title, filename, addedAt: new Date().toISOString() });
            }

            saveBookmarks(bookmarks);
            applyBookmarkedStates();
        }

        // Event listeners for bookmark buttons
        document.querySelectorAll('.bookmark-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const topicItem = this.closest('.topic-item');
                toggleBookmark(topicItem);
            });
        });

        // Initialize bookmarked states on page load
        applyBookmarkedStates();

        // Bookmarks modal management
        const bookmarksBtn = document.getElementById('bookmarks-btn');
        const bookmarksModal = document.getElementById('bookmarks-modal');
        const bookmarksList = document.getElementById('bookmarks-list');
        const bookmarksCount = document.getElementById('bookmarks-count');
        const closeBookmarksModalBtn = document.getElementById('close-bookmarks-modal');
        const clearAllBookmarksBtn = document.getElementById('clear-all-bookmarks');

        // Update bookmarks button visibility
        function updateBookmarksButton() {
            const bookmarks = getBookmarks();
            if (bookmarks.length > 0) {
                bookmarksBtn.style.display = 'block';
            } else {
                bookmarksBtn.style.display = 'none';
            }
        }

        // Render bookmarks list
        function renderBookmarksList() {
            const bookmarks = getBookmarks();
            bookmarksCount.textContent = `(${bookmarks.length})`;

            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<p class="gray tc pv4">No bookmarks yet</p>';
                return;
            }

            // Sort by addedAt descending (most recent first)
            const sorted = [...bookmarks].sort((a, b) =>
                new Date(b.addedAt) - new Date(a.addedAt)
            );

            bookmarksList.innerHTML = sorted.map(bookmark => `
                <div class="bookmark-item bg-white br2 pa3 mb2 flex items-center justify-between" data-url="${bookmark.url}">
                    <a href="${bookmark.url}" class="link near-black no-underline flex-auto">
                        <div class="f5 fw5">${bookmark.title}</div>
                        <div class="f7 gray mt1">${new Date(bookmark.addedAt).toLocaleDateString()}</div>
                    </a>
                    <button class="remove-bookmark-btn bn bg-transparent pointer pa2" data-url="${bookmark.url}" title="Remove bookmark">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 4L4 12M4 4l8 8"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-bookmark-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const url = this.getAttribute('data-url');
                    removeBookmark(url);
                });
            });
        }

        // Remove a single bookmark
        function removeBookmark(url) {
            const bookmarks = getBookmarks();
            const filtered = bookmarks.filter(b => b.url !== url);
            saveBookmarks(filtered);
            applyBookmarkedStates();
            renderBookmarksList();
            updateBookmarksButton();
        }

        // Clear all bookmarks
        function clearAllBookmarks() {
            if (confirm('Clear all bookmarks?')) {
                saveBookmarks([]);
                applyBookmarkedStates();
                renderBookmarksList();
                updateBookmarksButton();
                bookmarksModal.style.display = 'none';
            }
        }

        // Show bookmarks modal
        function showBookmarksModal() {
            renderBookmarksList();
            bookmarksModal.style.display = 'flex';
        }

        // Close bookmarks modal
        function closeBookmarksModal() {
            bookmarksModal.style.display = 'none';
        }

        // Event listeners
        bookmarksBtn.addEventListener('click', showBookmarksModal);
        closeBookmarksModalBtn.addEventListener('click', closeBookmarksModal);
        clearAllBookmarksBtn.addEventListener('click', clearAllBookmarks);

        // Close on background click
        bookmarksModal.addEventListener('click', function(e) {
            if (e.target === bookmarksModal) {
                closeBookmarksModal();
            }
        });

        // Close on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && bookmarksModal.style.display === 'flex') {
                closeBookmarksModal();
            }
        });

        // Update toggle to also update button visibility
        const originalToggleBookmark = toggleBookmark;
        toggleBookmark = function(topicItem) {
            originalToggleBookmark(topicItem);
            updateBookmarksButton();
        };

        // Initialize button visibility
        updateBookmarksButton();

        // ===== Preview Feature =====
        const previewModal = document.getElementById('preview-modal');
        const previewTitle = document.getElementById('preview-title');
        const previewContent = document.getElementById('preview-content');
        const closeModalBtn = document.getElementById('close-modal');
        const visitTopicBtn = document.getElementById('visit-topic');
        const markFromPreviewBtn = document.getElementById('mark-from-preview');
        let currentPreviewItem = null;

        // Open preview modal
        async function openPreview(topicItem) {
            currentPreviewItem = topicItem;
            const title = topicItem.getAttribute('data-title');
            const url = topicItem.getAttribute('data-url');

            // Set title and link
            previewTitle.textContent = title;
            visitTopicBtn.href = url;

            // Show modal with loading state
            previewModal.style.display = 'flex';
            previewContent.innerHTML = '<div class="flex items-center justify-center pv5"><div class="spinner"></div></div>';

            // Update mark button text based on current state
            updateMarkButton();

            // Fetch content
            try {
                const response = await fetch(url);
                const html = await response.text();

                // Parse HTML and extract main content
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Try to find the main content area (adjust selector based on your layout)
                const mainContent = doc.querySelector('main') || doc.querySelector('.post-content') || doc.querySelector('article');

                if (mainContent) {
                    previewContent.innerHTML = mainContent.innerHTML;
                } else {
                    previewContent.innerHTML = '<p class="gray">Could not load preview content.</p>';
                }
            } catch (error) {
                previewContent.innerHTML = '<p class="red">Error loading content. Please try visiting the page directly.</p>';
            }
        }

        // Close preview modal
        function closePreview() {
            previewModal.style.display = 'none';
            currentPreviewItem = null;
        }

        // Update mark button text
        function updateMarkButton() {
            if (!currentPreviewItem) return;
            const filename = currentPreviewItem.getAttribute('data-filename');
            const marked = getMarkedTopics();
            const isMarked = marked.some(m => m.filename === filename);
            markFromPreviewBtn.textContent = isMarked ? 'Unmark' : 'Mark for Deletion';
            markFromPreviewBtn.style.backgroundColor = isMarked ? '#ddd' : '#ffebe9';
        }

        // Event listeners for preview buttons
        document.querySelectorAll('.preview-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const topicItem = this.closest('.topic-item');
                openPreview(topicItem);
            });
        });

        // Close modal
        closeModalBtn.addEventListener('click', closePreview);

        // Close on background click
        previewModal.addEventListener('click', function(e) {
            if (e.target === previewModal) {
                closePreview();
            }
        });

        // Close on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && previewModal.style.display === 'flex') {
                closePreview();
            }
        });

        // Mark from preview
        markFromPreviewBtn.addEventListener('click', function() {
            if (currentPreviewItem) {
                toggleMarked(currentPreviewItem);
                updateMarkButton();
            }
        });
    });
</script>
{{ end }}
